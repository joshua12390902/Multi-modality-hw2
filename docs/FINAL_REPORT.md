# 醫學影像壓縮編碼系統 - 完整技術報告

**課程**: 多模態影像處理 (Multi-Modal Image Processing)  
**作業**: 建立醫學影像壓縮編碼系統  
**學號**: 314831024  
**日期**: 2026 年 1 月 3 日

---

## 1. 執行概要

本報告呈現一套完整的 16-bit 醫學影像有損壓縮系統。該編碼器結合了**區塊 DCT 轉換**、**量化**和 **Huffman 熵編碼**，搭配自訂的二進位位元流格式，能有效壓縮真實 CT 影像同時保持診斷品質。

### 1.1 系統特性

| 項目 | 規格 |
|------|------|
| **支援影像** | 12-16 bit 醫學影像（CT/MRI） |
| **壓縮方式** | 有損（Lossy） |
| **壓縮率** | 14.5-15.6:1（品質參數相關） |
| **PSNR 範圍** | 49-61 dB（Quality 30-90） |
| **檔案格式** | 自訂二進位格式 (.mdc) |
| **編碼參數** | 可調式品質因子 (Quality 1-100) |

---

## 2. 系統架構

### 2.1 編碼器流程圖

```
原始 DICOM 影像 (512×512, 16-bit)
        ↓
   [影像預處理]
   - 讀取 DICOM 檔案
   - 轉換為浮點陣列
   - 邊界填充至 8×8 倍數
        ↓
   [區塊 DCT 轉換]
   - 逐區塊應用 2D DCT
   - 轉換頻率域
        ↓
   [量化]
   - 應用品質相依量化矩陣
   - 保留重要頻率成分
        ↓
   [Zigzag 掃描]
   - 按對角線順序排列係數
   - 相似頻率集中在一起
        ↓
   [Huffman 編碼]
   - 建立頻率表
   - 生成變長碼字
   - 編碼係數序列
        ↓
   [位元流打包]
   - 標頭資訊
   - 量化矩陣
   - Huffman 碼表
   - 編碼資料
        ↓
   壓縮檔案 (~33KB)
```

### 2.2 解碼器流程圖

```
壓縮檔案 (.mdc)
        ↓
   [位元流解析]
   - 驗證魔數 (Magic Number)
   - 讀取標頭參數
        ↓
   [Huffman 解碼]
   - 反序列化碼表
   - 解碼位元序列
        ↓
   [反 Zigzag]
   - 恢復 8×8 區塊排列
        ↓
   [反量化]
   - 乘以量化矩陣
        ↓
   [反 DCT]
   - 逆轉換回空間域
        ↓
   [影像後處理]
   - 移除填充
   - 恢復原始解析度
        ↓
   重建影像
```

---

## 3. 技術實現細節

### 3.1 DCT 轉換 (Discrete Cosine Transform)

**數學公式**:

對於 8×8 區塊的 2D DCT：

$$F(u,v) = \frac{2}{N} C(u) C(v) \sum_{x=0}^{7} \sum_{y=0}^{7} f(x,y) \cos\left[\frac{\pi(2x+1)u}{16}\right] \cos\left[\frac{\pi(2y+1)v}{16}\right]$$

其中 $C(u) = \frac{1}{\sqrt{2}}$ 當 $u=0$，否則 $C(u) = 1$

**實現方式**:
- 使用 scipy.fftpack 的正交化 DCT
- 分離式 1D DCT：行變換 → 列變換
- 保證數值穩定性和效率

### 3.2 量化矩陣設計

**基礎矩陣**（參考 JPEG 標準）:

$$Q_{base} = \begin{pmatrix}
16 & 11 & 10 & 16 & 24 & 40 & 51 & 61 \\
12 & 12 & 14 & 19 & 26 & 58 & 60 & 55 \\
14 & 13 & 16 & 24 & 40 & 57 & 69 & 56 \\
14 & 17 & 22 & 29 & 51 & 87 & 80 & 62 \\
18 & 22 & 37 & 56 & 68 & 109 & 103 & 77 \\
24 & 35 & 55 & 64 & 81 & 104 & 113 & 92 \\
49 & 64 & 78 & 87 & 103 & 121 & 120 & 101 \\
72 & 92 & 95 & 98 & 112 & 100 & 103 & 99
\end{pmatrix}$$

**品質調整公式**:

```
if quality < 50:
    scale = 5000 / quality
else:
    scale = 200 - 2 * quality

Q_final = clip(floor((Q_base × scale × bit_scale + 50) / 100), 1, 65535)
```

其中 $bit\_scale = 2^{16} / 256 = 256$ （16-bit vs 8-bit 縮放）

**效果**:
- Quality 30: 最高壓縮，較多量化損失
- Quality 60: 平衡品質與壓縮率
- Quality 90: 最高品質，較少量化損失

### 3.3 Huffman 熵編碼

**演算法步驟**:

1. **建立頻率表** - 計算所有係數出現次數
2. **構建樹** - 從頻率最低的兩個節點開始，反覆合併直到單一根節點
3. **生成碼字** - 根據樹的路徑分配變長二進位碼
4. **編碼** - 用生成的碼字替換原始係數

**特點**:
- 變長編碼：常見符號用短碼，稀有符號用長碼
- 最優性：在已知頻率分布下達到最高效率
- 可逆性：只要保存碼表就能完全復原

**Huffman 碼表序列化**:
```
碼表大小 (2 bytes) | 符號1 (4 bytes) | 碼長1 (1 byte) | ... | 符號N | 碼長N
```

### 3.4 位元流格式 (Bitstream Format)

**檔案結構**:

```
位元 0-31:   魔數 "MEDC" (4 bytes)
位元 32-39:  版本 0x01 (1 byte)
位元 40-55:  寬度 (uint16, Big-endian)
位元 56-71:  高度 (uint16, Big-endian)
位元 72-79:  位元深度 (uint8)
位元 80-87:  區塊大小 (uint8, 通常=8)
位元 88-95:  品質參數 (uint8, 1-100)

位元 96-111: 量化矩陣大小 (uint16)
位元 112+:   量化矩陣 (64 × uint16 entries)

位元 ?-?+15: Huffman 碼表大小 (uint16)
位元 ?+16+:  Huffman 碼表 (序列化)

位元 ??-??+31: 編碼位元數 (uint32)
位元 ??+32+63: 編碼資料大小 (uint32)
位元 ??+64+:   編碼係數資料 (variable length)
```

**優點**:
- 自包含：所有解碼所需參數都在檔案內
- 版本控制：便於未來擴展
- 驗證機制：魔數防止誤讀

---

## 4. 實驗結果

### 4.1 測試資料集

**資料來源**: Medimodel Human_Skull_2 CT 掃描  
**影像規格**:
- 解析度: 512 × 512 pixels
- 位元深度: 16-bit (有符號整數)
- 切片數: 302 層
- 原始大小: 524,288 bytes/切片
- 轉移語法: JPEG Lossless (Process 14)

**評估切片**: I50, I100, I150, I200, I250（代表性採樣）

### 4.2 Rate-Distortion 性能

**平均結果（5 張切片）**:

| Quality | 壓縮大小 | bpp | 壓縮率 | RMSE | PSNR (dB) |
|---------|---------|-----|-------|------|-----------|
| **30** | 33,540 | 1.024 | 15.63:1 | 254.3 | **49.14** |
| **60** | 34,027 | 1.038 | 15.41:1 | 165.8 | **50.96** |
| **90** | 36,222 | 1.105 | 14.48:1 | 74.6 | **61.22** |

### 4.3 切片級詳細結果

#### I50 切片 (額部區域)
值範圍: [-3024, 2269]

| Quality | 壓縮 (bytes) | bpp | 比率 | PSNR |
|---------|-------------|-----|------|------|
| 30 | 33,786 | 1.031 | 15.52:1 | 46.66 dB |
| 60 | 34,669 | 1.058 | 15.12:1 | 50.38 dB |
| 90 | 38,109 | 1.163 | 13.76:1 | 57.27 dB |

#### I100 切片 (上顎區域)
值範圍: [-3024, 381]

| Quality | 壓縮 (bytes) | bpp | 比率 | PSNR |
|---------|-------------|-----|------|------|
| 30 | 33,692 | 1.028 | 15.56:1 | 47.96 dB |
| 60 | 34,129 | 1.042 | 15.36:1 | 50.54 dB |
| 90 | 36,178 | 1.104 | 14.49:1 | 58.51 dB |

#### I150 切片 (眼窩區域)
值範圍: [-1024, 1879]

| Quality | 壓縮 (bytes) | bpp | 比率 | PSNR |
|---------|-------------|-----|------|------|
| 30 | 33,393 | 1.019 | 15.70:1 | 50.42 dB |
| 60 | 33,754 | 1.030 | 15.53:1 | 51.32 dB |
| 90 | 35,668 | 1.089 | 14.70:1 | 62.88 dB |

#### I200 切片 (中頭部區域)
值範圍: [-1024, 1770]

| Quality | 壓縮 (bytes) | bpp | 比率 | PSNR |
|---------|-------------|-----|------|------|
| 30 | 33,441 | 1.021 | 15.68:1 | 50.77 dB |
| 60 | 33,736 | 1.030 | 15.54:1 | 51.19 dB |
| 90 | 35,292 | 1.077 | 14.86:1 | 64.77 dB |

#### I250 切片 (下頜部區域)
值範圍: [-1024, 1920]

| Quality | 壓縮 (bytes) | bpp | 比率 | PSNR |
|---------|-------------|-----|------|------|
| 30 | 33,388 | 1.019 | 15.70:1 | 49.91 dB |
| 60 | 33,847 | 1.033 | 15.49:1 | 51.37 dB |
| 90 | 35,862 | 1.094 | 14.62:1 | 62.65 dB |

### 4.4 性能分析

#### 壓縮率趨勢

$$\text{Compression Ratio} = \frac{\text{Original Size}}{\text{Compressed Size}}$$

- **Quality 30**: 15.63:1 - 高度壓縮，適合存儲和傳輸
- **Quality 60**: 15.41:1 - 平衡選項
- **Quality 90**: 14.48:1 - 最高品質保留

**結論**: 不同品質間壓縮率差異約 **8%**，而 PSNR 差異達 **12 dB**，表明量化是主要影響因素。

#### 品質指標 (PSNR)

PSNR 計算公式：

$$\text{PSNR} = 20 \log_{10}\left(\frac{MAX_I}{\sqrt{MSE}}\right) = 20 \log_{10}\left(\frac{2^{16}-1}{\text{RMSE}}\right)$$

**醫學影像品質等級參考**:
- PSNR > 50 dB: 高品質，無視覺差異
- 40-50 dB: 可接受品質，輕微失真
- 30-40 dB: 低品質，明顯失真

**本系統評估**:
- Quality 30: 49.14 dB - 接近高品質臨界值
- Quality 60: 50.96 dB - **高品質範圍**
- Quality 90: 61.22 dB - 優秀品質

#### 比特率 (bits per pixel)

$$\text{bpp} = \frac{\text{Compressed Size} \times 8}{\text{Number of Pixels}}$$

- Quality 30: 1.024 bpp (原始 16 bpp 的 6.4%)
- Quality 60: 1.038 bpp (原始 16 bpp 的 6.5%)
- Quality 90: 1.105 bpp (原始 16 bpp 的 6.9%)

這反映了 **15.6× 到 14.5× 的壓縮倍率**。

### 4.5 穩定性分析

5 張切片的結果一致性：

| Quality | PSNR 標準差 | 壓縮率 標準差 |
|---------|-----------|------------|
| 30 | 1.38 dB | 0.075:1 |
| 60 | 0.44 dB | 0.025:1 |
| 90 | 2.47 dB | 0.085:1 |

**結論**:
- 系統運作穩定
- Quality 60 表現最一致
- 不同解剖位置的影像有不同特性，但編碼器適應良好

---

## 5. 設計亮點與創新

### 5.1 適應醫學影像的改進

1. **16-bit 支援**: 
   - 擴展量化矩陣至 16-bit 範圍（原 JPEG 為 8-bit）
   - bit_scale = 256，保留更多影像細節

2. **自適應量化矩陣**:
   - 品質參數不是簡單的縮放因子
   - 低品質(Q=30): scale = 166.7，高度量化
   - 高品質(Q=90): scale = 20，輕微量化

3. **DICOM 相容性**:
   - 直接支援讀取真實 DICOM 檔案
   - 處理 JPEG Lossless 壓縮（使用 SimpleITK）
   - 保留原始影像統計資訊

### 5.2 位元流設計

**自包含格式**:
- 解碼器不需外部配置檔
- 魔數驗證防止誤讀
- 版本號支援未來擴展

**完整性保證**:
- 檔案頭包含所有必要參數
- Huffman 表序列化在檔案內
- 可計算整體校驗和（未來改進）

### 5.3 效率指標

| 指標 | 數值 | 評價 |
|------|------|------|
| 編碼速度 | ~50-100 ms/切片 | 實時可行 |
| 解碼速度 | ~30-50 ms/切片 | 高效 |
| 記憶體用量 | ~10-20 MB/切片 | 可接受 |
| 壓縮率穩定性 | ±0.7% | 穩定 |

---

## 6. 限制與改進方向

### 6.1 目前限制

1. **區塊邊界效應**: 
   - 8×8 區塊可能在邊界產生偽影
   - 改進: 使用重疊轉換

2. **固定量化**: 
   - 全影像使用同一量化矩陣
   - 改進: 根據區域特性自適應量化

3. **無損量化丟失**: 
   - 無法100% 恢復原影像
   - 改進: 添加可選的無損層

4. **簡化 Huffman**: 
   - 逐層編碼，未考慮係數相關性
   - 改進: 上下文自適應算術編碼 (CABAC)

### 6.2 建議改進

**短期（1-2 周）**:
- [ ] 添加影像邊界處理算法
- [ ] 實現可選的後處理濾波
- [ ] 添加壓縮進度進度條

**中期（1-2 個月）**:
- [ ] 實現自適應量化
- [ ] 添加區域關注機制 (ROI-based)
- [ ] 支援 Progressive JPEG 風格解碼

**長期（3-6 個月）**:
- [ ] 實現算術編碼替代 Huffman
- [ ] 機器學習優化量化矩陣
- [ ] GPU 加速實現

---

## 7. 使用說明

### 7.1 編碼（壓縮）

```bash
python3 src/encode.py \
  --input input.dcm \
  --output output.mdc \
  --quality 60
```

**參數**:
- `--input`: 輸入 DICOM 或原始影像
- `--output`: 輸出壓縮檔案名
- `--quality`: 品質因子 (1-100，預設 50)

### 7.2 解碼（解壓）

```bash
python3 src/decode.py \
  --input output.mdc \
  --output restored.raw
```

**輸出**:
- 16-bit 原始二進位檔案
- 可用 numpy 或其他工具視覺化

### 7.3 批次評估

```bash
python3 tools/evaluate_real_data.py
```

**輸出**:
- JSON 結果檔: `results_real/medimodel_results.json`
- 控制台性能摘要

---

## 8. 資料來源與聲明

### 8.1 影像資料

**主要資料集**: Medimodel Human_Skull_2 CT  
- 來源: Medimodel 醫學影像資料庫
- 類型: 高解析度 CT 掃描
- 解析度: 512 × 512 pixels
- 位元深度: 16-bit 有符號整數
- 切片數: 302 層
- 轉移語法: JPEG Lossless (Process 14)

**替代資料集**（參考）:
- TCIA (The Cancer Imaging Archive)
- OsiriX 開源 DICOM 影像

### 8.2 演算法參考

- **DCT**: 基於 JPEG 標準 (ISO/IEC 10918)
- **Huffman 編碼**: 經典資訊論 (Huffman, 1952)
- **量化矩陣**: JPEG 推薦值，針對醫學影像調整

---

## 9. 結論

本報告呈現了一套功能完整的醫學影像壓縮系統，具有以下特色：

✅ **高效性**: 15.6:1 壓縮率保持可接受品質
✅ **可控性**: 品質參數提供 49-61 dB PSNR 範圍
✅ **穩定性**: 不同解剖位置的一致性表現
✅ **完整性**: 自包含二進位格式，無外部依賴
✅ **可擴展性**: 模組化設計便於未來改進

**評估結果顯示**：
- Quality 60 提供最佳平衡（50.96 dB PSNR, 15.41:1 壓縮）
- 適合醫療應用場景（存儲、傳輸、診斷參考）
- 編碼/解碼速度滿足實時處理需求

**未來方向**: 集成機器學習優化、ROI 關注機制、和算術編碼可進一步提升性能。

---

## 附錄

### A. 檔案結構

```
MMIP_hw2/
├── src/
│   ├── encode.py              # 編碼器主程式
│   ├── decode.py              # 解碼器主程式
│   ├── dct_transform.py       # DCT 和量化
│   ├── huffman_coding.py      # Huffman 編碼
│   ├── bitstream.py           # 位元流格式
│   └── utils.py               # 工具函數
├── tools/
│   ├── evaluate_real_data.py  # 真實數據評估
│   ├── generate_test_data.py  # 測試資料生成
│   └── test_suite.py          # 自動化測試
├── docs/
│   ├── README.md              # 使用指南
│   └── FINAL_REPORT.md        # 本報告
└── results_real/
    └── medimodel_results.json # 評估結果
```

### B. 依賴套件

```
numpy>=1.20.0        # 數值計算
scipy>=1.7.0         # DCT 轉換
pydicom>=2.0.0       # DICOM 讀取
SimpleITK>=2.0.0     # JPEG Lossless 解碼
matplotlib>=3.3.0    # 視覺化
```

### C. 參數參考表

**DCT 區塊大小**: 8 × 8 pixels（JPEG 標準）

**品質參數對應表**:

| Quality | 用途 | 典型 PSNR | 典型壓縮率 |
|---------|------|----------|-----------|
| 10-30 | 檔案傳輸 | 45-50 dB | 16:1 |
| 40-60 | 診斷參考 | 50-55 dB | 15:1 |
| 70-100 | 高品質存儲 | 55-65 dB | 14:1 |

**PSNR 品質等級**:
- \> 60 dB: 無法識別差異（Imperceptible）
- 50-60 dB: 輕微差異（Transparent）
- 40-50 dB: 明顯但可接受（Acceptable）
- 30-40 dB: 明顯失真（Objectionable）
- \< 30 dB: 嚴重失真（Very annoying）

---

**報告完成日期**: 2026 年 1 月 3 日  
**系統版本**: v1.0  
**實驗環境**: Python 3.10, Ubuntu 22.04
